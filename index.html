<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ARM-Linux-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/30/ARM-Linux-note/" class="article-date">
  <time datetime="2018-03-30T15:00:25.562Z" itemprop="datePublished">2018-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ARM-Linux-note"><a href="#ARM-Linux-note" class="headerlink" title="ARM-Linux-note"></a>ARM-Linux-note</h1><p>标签（空格分隔）： uboot kernel filesystem</p>
<hr>
<pre><code>该系列文章是基于百问网（www.100ask.org)提供的资料以及开发板学习过程中的总结

说明关于引用来自代码或者代码中的说明采用了插入代码的格式来说明。
以区分我书写的和实际引用的，这种方式是为了保持格式，阅读起来更具有美感。

本人联系方式：598541169@qq.com


本文将从硬件、uboot、linux内核等来解析
</code></pre><hr>
<h1 id="0-Hardware"><a href="#0-Hardware" class="headerlink" title="0.Hardware"></a>0.Hardware</h1><pre><code>硬件平台：JZ2440(百问网)
①CPU：s3c2440
</code></pre><hr>
<pre><code>启动模型：uboot-&gt;linux-&gt;file system-&gt;application
</code></pre><h1 id="1-Uboot"><a href="#1-Uboot" class="headerlink" title="1.Uboot"></a>1.Uboot</h1><h2 id="Read-Me："><a href="#Read-Me：" class="headerlink" title="Read Me："></a>Read Me：</h2><pre><code>uboot version ：u-boot-2.1.6  
readme 文件目录介绍
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- board		Board dependent files</span><br><span class="line">- common	Misc architecture independent functions</span><br><span class="line">- cpu		CPU specific files</span><br><span class="line">  - <span class="number">74</span>xx_7xx	Files specific to Freescale MPC74xx <span class="keyword">and</span> <span class="number">7</span>xx CPUs</span><br><span class="line">  - arm720t	Files specific to ARM <span class="number">720</span> CPUs</span><br><span class="line">  - arm920t	Files specific to ARM <span class="number">920</span> CPUs</span><br><span class="line">    - at91rm9200 Files specific to Atmel AT91RM9200 CPU</span><br><span class="line">    - imx	Files specific to Freescale MC9328 i.MX CPUs</span><br><span class="line">    - s3c24x0	Files specific to Samsung S3C24X0 CPUs</span><br><span class="line">  - arm925t	Files specific to ARM <span class="number">925</span> CPUs</span><br><span class="line">  - arm926ejs	Files specific to ARM <span class="number">926</span> CPUs</span><br><span class="line">  - arm1136	Files specific to ARM <span class="number">1136</span> CPUs</span><br><span class="line">  - at32ap	Files specific to Atmel AVR32 AP CPUs</span><br><span class="line">  - i386	Files specific to i386 CPUs</span><br><span class="line">  - ixp		Files specific to Intel XScale IXP CPUs</span><br><span class="line">  - mcf52x2	Files specific to Freescale ColdFire MCF52x2 CPUs</span><br><span class="line">  - mips	Files specific to MIPS CPUs</span><br><span class="line">  - mpc5xx	Files specific to Freescale MPC5xx  CPUs</span><br><span class="line">  - mpc5xxx	Files specific to Freescale MPC5xxx CPUs</span><br><span class="line">  - mpc8xx	Files specific to Freescale MPC8xx  CPUs</span><br><span class="line">  - mpc8220	Files specific to Freescale MPC8220 CPUs</span><br><span class="line">  - mpc824x	Files specific to Freescale MPC824x CPUs</span><br><span class="line">  - mpc8260	Files specific to Freescale MPC8260 CPUs</span><br><span class="line">  - mpc85xx	Files specific to Freescale MPC85xx CPUs</span><br><span class="line">  - nios	Files specific to Altera NIOS CPUs</span><br><span class="line">  - nios2	Files specific to Altera Nios-II CPUs</span><br><span class="line">  - ppc4xx	Files specific to AMCC PowerPC <span class="number">4</span>xx CPUs</span><br><span class="line">  - pxa		Files specific to Intel XScale PXA CPUs</span><br><span class="line">  - s3c44b0	Files specific to Samsung S3C44B0 CPUs</span><br><span class="line">  - sa1100	Files specific to Intel StrongARM SA1100 CPUs</span><br><span class="line">- disk		Code <span class="keyword">for</span> disk drive partition handling</span><br><span class="line">- doc		Documentation (don't expect too much)</span><br><span class="line">- drivers	Commonly used device drivers</span><br><span class="line">- dtt		Digital Thermometer <span class="keyword">and</span> Thermostat drivers</span><br><span class="line">- examples  Example code <span class="keyword">for</span> standalone applications, etc.</span><br><span class="line">- include	Header Files</span><br><span class="line">- lib_arm	Files generic to ARM	 architecture</span><br><span class="line">- lib_avr32	Files generic to AVR32	 architecture</span><br><span class="line">- lib_generic	Files generic to all	 architectures</span><br><span class="line">- lib_i386	   Files generic to i386	 architecture</span><br><span class="line">- lib_m68k	Files generic to m68k	 architecture</span><br><span class="line">- lib_mips	Files generic to MIPS	 architecture</span><br><span class="line">- lib_nios	Files generic to NIOS	 architecture</span><br><span class="line">- lib_ppc	Files generic to PowerPC architecture</span><br><span class="line">- net		Networking code</span><br><span class="line">- post		Power On Self Test</span><br><span class="line">- rtc		Real Time Clock drivers</span><br><span class="line">- tools		Tools to build S-Record <span class="keyword">or</span> U-Boot images, etc.</span><br></pre></td></tr></table></figure>
<h3 id="1-board"><a href="#1-board" class="headerlink" title="1.board"></a>1.board</h3><p>本目录存放与已有开发板相关的文件。每种开发板有一个子目录，子目录仅存放与开发板相关的c文件和配置文件，不包含开发板CPU架构通用的实现文件。<br><code>.\u-boot-1.1.6_jz2440\u-boot-1.1.6\board\100ask24x0:</code></p>
<blockquote>
<ul>
<li>100ask24x0.c</li>
<li>boot_init.c</li>
<li>config.mk</li>
<li>flash.c</li>
<li>lowlevel_init.S</li>
<li>Makefile</li>
<li>u-boot.lds</li>
</ul>
</blockquote>
<h3 id="2-common"><a href="#2-common" class="headerlink" title="2.common"></a>2.common</h3><p>实现u-boot命令行下支持的命令。例如bootm命令对应的是cmd_bootm.c。另外还包括一些需要辅助使用的文件。</p>
<h3 id="3-CPU"><a href="#3-CPU" class="headerlink" title="3.CPU"></a>3.CPU</h3><p>与处理器体系架构相关目录<br><code>.\u-boot-1.1.6_jz2440\u-boot-1.1.6\cpu\arm920t</code></p>
<blockquote>
<ul>
<li>start.S</li>
<li>Makefile</li>
<li>interrupts.c</li>
<li>cpu.c</li>
<li>config.mk</li>
</ul>
</blockquote>
<p>平台相关的和CPU架构相关代码<br><code>\u-boot-1.1.6_jz2440\u-boot-1.1.6\cpu\arm920t\s3c24x0</code></p>
<h3 id="4-disk"><a href="#4-disk" class="headerlink" title="4.disk"></a>4.disk</h3><p>对磁盘的支持。</p>
<h3 id="5-doc"><a href="#5-doc" class="headerlink" title="5.doc"></a>5.doc</h3><p>文档目录。</p>
<h3 id="6-drivers"><a href="#6-drivers" class="headerlink" title="6.drivers"></a>6.drivers</h3><p>设备驱动程序目录。比如串口、USB、mmc等。</p>
<h3 id="7-fs"><a href="#7-fs" class="headerlink" title="7.fs"></a>7.fs</h3><p>支持的文件系统。u-boot支持cramfs、ext2、fat、fdos、jffs2、reiserfs、ubifs、yaffs2文件系统。</p>
<h3 id="8-include"><a href="#8-include" class="headerlink" title="8.include"></a>8.include</h3><p>使用的头文件均在改目录下，还有对各种硬件平台支持的汇编文件、系统配置文件和文件系统支持的文件。<br>该目录下configs目录有与开发板相关的配置文件。例如<br><code>u-boot-1.1.6_jz2440\u-boot-1.1.6\include\configs</code> <code>100ask24x0.h</code><br>该目录下asm目录有与cpu体系结构相关的头文件，例如asm-arm目录下有<br><code>u-boot-1.1.6_jz2440\u-boot-1.1.6\include\asm-arm\arch-s3c24x0</code></p>
<h3 id="9-lib"><a href="#9-lib" class="headerlink" title="9.lib"></a>9.lib</h3><p>所有处理器通用的库文件。</p>
<h3 id="10-net"><a href="#10-net" class="headerlink" title="10.net"></a>10.net</h3><p>与网络协议栈相关的代码，bootp协议、tftp协议、rarp协议和nfs文件系统等实现。</p>
<h3 id="11-tools"><a href="#11-tools" class="headerlink" title="11.tools"></a>11.tools</h3><p>生成u-boot工具，例如mkimage。</p>
<h3 id="12-api"><a href="#12-api" class="headerlink" title="12.api"></a>12.api</h3><p>处理器或者开发板为外部应用程序提供独立的API。</p>
<h3 id="13-example"><a href="#13-example" class="headerlink" title="13.example"></a>13.example</h3><p>一些独立的应用程序示范代码。 </p>
<h3 id="14-其他-etc。"><a href="#14-其他-etc。" class="headerlink" title="14.其他 etc。"></a>14.其他 etc。</h3><hr>
<p>如何使用uboot config 参考readme示例：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Example: For a TQM823L module type:</span><br><span class="line">	cd   u-boot</span><br><span class="line">	make TQM823L_config</span><br></pre></td></tr></table></figure>
<p>除此之外关于代码中各种编译的宏定义说明<br>关于如何使用uboot自定义到自己的board，uboot readme 给出了相关指示信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">	If the system board that you have is <span class="keyword">not</span> listed, then you will need</span><br><span class="line">to port U-Boot to your hardware platform. To <span class="keyword">do</span> <span class="keyword">this</span>, follow these</span><br><span class="line">steps:</span><br><span class="line"><span class="number">1.</span>  Add a <span class="keyword">new</span> configuration option <span class="keyword">for</span> your board to the toplevel</span><br><span class="line">    <span class="string">"Makefile"</span> <span class="keyword">and</span> to the <span class="string">"MAKEALL"</span> script, <span class="keyword">using</span> the existing</span><br><span class="line">    entries as examples. Note that here <span class="keyword">and</span> at many other places</span><br><span class="line">    boards <span class="keyword">and</span> other names are listed in alphabetical sort order. Please</span><br><span class="line">    keep <span class="keyword">this</span> order.</span><br><span class="line"><span class="number">2.</span>  Create a <span class="keyword">new</span> directory to hold your board specific code. Add any</span><br><span class="line">    files you need. In your board directory, you will need at least</span><br><span class="line">    the <span class="string">"Makefile"</span>, a <span class="string">"&lt;board&gt;.c"</span>, <span class="string">"flash.c"</span> <span class="keyword">and</span> <span class="string">"u-boot.lds"</span>.</span><br><span class="line"><span class="number">3.</span>  Create a <span class="keyword">new</span> configuration file <span class="string">"include/configs/&lt;board&gt;.h"</span> <span class="keyword">for</span></span><br><span class="line">    your board</span><br><span class="line"><span class="number">3.</span>  If you're porting U-Boot to a <span class="keyword">new</span> CPU, then also create a <span class="keyword">new</span></span><br><span class="line">    directory to hold your CPU specific code. Add any files you need.</span><br><span class="line"><span class="number">4.</span>  Run <span class="string">"make &lt;board&gt;_config"</span> with your <span class="keyword">new</span> name.</span><br><span class="line"><span class="number">5.</span>  Type <span class="string">"make"</span>, <span class="keyword">and</span> you should get a working <span class="string">"u-boot.srec"</span> file</span><br><span class="line">    to be installed on your target system.</span><br><span class="line"><span class="number">6.</span>  Debug <span class="keyword">and</span> solve any problems that might arise.</span><br><span class="line">    [Of course, <span class="keyword">this</span> last step is much harder than it sounds.]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Testing of U-Boot Modifications, Ports to New Hardware, etc.:</span><br></pre></td></tr></table></figure>
<p>配置CPU 、配置板载信息、以及各项外设功能，编译。<br>同时uboot中本身也集成了部分的 Monitor Commands 用语调试 我们可以以此为参考来方便和内部代码交互。</p>
<p>uboot在初始化ram后，arm各个寄存器的状态如下 ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">On ARM, the following registers are used:</span><br><span class="line">	R0:	function argument word/integer result</span><br><span class="line">	R1-R3:	function argument word</span><br><span class="line">	R9:	GOT pointer</span><br><span class="line">    	R10:	stack limit (used only if stack checking if enabled)</span><br><span class="line">	R11:	argument (frame) pointer</span><br><span class="line">	R12:	temporary workspace</span><br><span class="line">	R13:	stack pointer</span><br><span class="line">	R14:	link register</span><br><span class="line">	R15:	program counter</span><br><span class="line">    ==&gt; U-Boot will use R8 to hold a pointer to the global data</span><br><span class="line">NOTE: DECLARE_GLOBAL_DATA_PTR must be used with file-global scope,</span><br><span class="line">or current versions of GCC may &quot;optimize&quot; the code too much.</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="Lds："><a href="#Lds：" class="headerlink" title="Lds："></a>Lds：</h2><p>链接脚本：在编译器经过：预处理-编译-汇编后 再链接为ELF文件，使用gcc命令最后转化为平台可以使用的.bin 文件，最后download到board。链接脚本对应存放在对应的单板文件夹下：<br><code>u-boot-1.1.6\board\100ask24x0</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//arm 小端模式</span></span><br><span class="line">OUTPUT_FORMAT(<span class="string">"elf32-littlearm"</span>, <span class="string">"elf32-littlearm"</span>, <span class="string">"elf32-littlearm"</span>)             </span><br><span class="line"><span class="comment">/*OUTPUT_FORMAT("elf32-arm", "elf32-arm", "elf32-arm")*/</span></span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line"><span class="comment">//链接入口地址指针为 lable：_start</span></span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">	. = <span class="number">0x00000000</span>;</span><br><span class="line">    <span class="comment">//四字节对齐	</span></span><br><span class="line">	. = ALIGN(<span class="number">4</span>);</span><br><span class="line">	<span class="comment">//文本段code</span></span><br><span class="line">	.text      : </span><br><span class="line">	&#123;</span><br><span class="line">	  cpu/arm920t/start.o	(.text)<span class="comment">//顺序位置第一优先运行这个文件，关联为start.S</span></span><br><span class="line">		<span class="comment">//然后运行改文件，一些CPU硬件核心的初始化 这两者组成了uboot启动的第一阶段</span></span><br><span class="line">          board/<span class="number">100</span>ask24x0/boot_init.o (.text)</span><br><span class="line">	  *(.text)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	. = ALIGN(<span class="number">4</span>);</span><br><span class="line">	.rodata : &#123; *(.rodata) &#125; <span class="comment">//只读数据段</span></span><br><span class="line"></span><br><span class="line">	. = ALIGN(<span class="number">4</span>);</span><br><span class="line">	.data : &#123; *(.data) &#125; <span class="comment">//数据段</span></span><br><span class="line"></span><br><span class="line">	. = ALIGN(<span class="number">4</span>);</span><br><span class="line">	.got : &#123; *(.got) &#125;<span class="comment">//指定got段, got段式是uboot自定义的一个段, 非标准段</span></span><br><span class="line"></span><br><span class="line">	. = .;</span><br><span class="line">	__u_boot_cmd_start = .;  <span class="comment">//uboot 命令存放地址起始：</span></span><br><span class="line">	.u_boot_cmd : &#123; *(.u_boot_cmd) &#125;</span><br><span class="line">	__u_boot_cmd_end = .;  <span class="comment">//命令结束地址</span></span><br><span class="line"></span><br><span class="line">	. = ALIGN(<span class="number">4</span>);</span><br><span class="line">	__bss_start = .; <span class="comment">//bss段</span></span><br><span class="line">	.bss : &#123; *(.bss) &#125;</span><br><span class="line">	_end = .;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从链接脚本中最为重要的是一个开始执行的地址 0x00000000 ，还有一个是第一个txt文本代码链接的是start，这是我们分析uboot的起始文件入口。<br>在目录中定义了我们jz2440的 txtbase地址TEXT_BASE = 0x33F80000这个是我们存放代码在sdaram中位置，是在重映射之后。那么运行地址是在0x33F80000</p>
<h2 id="config-mk："><a href="#config-mk：" class="headerlink" title="_config.mk："></a>_config.mk：</h2><p>想要得到最后的uboot.bin文件我们需要进行两个步骤：<br>    ①<code>make 100ask24x0_config</code> //此处执行配置文件<br>    ②<code>make</code>                    //编译uboot</p>
<p>调用第一条的时候会自动执行make 参考的是改文件 在Makefile中具体会执行：</p>
<p><code>100ask24x0_config    :    unconfig</code><br>    <code>@$(MKCONFIG) $(@:_config=) arm arm920t 100ask24x0 NULL s3c24x0</code><br>其中 <code>MKCONFIG    := $(SRCTREE)/mkconfig</code> 在<code>sourcetree</code> 中的<code>mkconfig</code>，根目录中的<code>mkconfig</code>文件</p>
<p><code>$(@:_config=) :arm arm920t 100ask24x0 samsung s3c24x0</code><br><code>$(@:_config=)</code>为将传进来的所有参数中的<code>_config</code>替换为空其中@指规则的目标文件名，在这里就是<code>100ask24x0_config</code><br><code>$(text:patternA=patternB)</code>，这样的语法表示把text变量每一个元素中结尾的patternA的文本替换为patternB，然后输出。</p>
<p>因此<code>$(@:_config=)</code>的作用就是将<code>100ask24x0_config</code>中的<code>_config</code>去掉，得到<code>100ask24x0</code>。：</p>
<p><code>./mkconfig 100ask24x0 arm arm920t 100ask24x0 samsung s3c24x0</code><br>即将<code>100ask24x0($1) arm($2) arm920t($3) 100ask24x0($4) NULL($5) s3c24x0($6)</code><br>作为参数传递给当前目录下的mkconfig脚本执行。  </p>
<p>unconfig:<br><code>@rm -f $(obj)include/config.h $(obj)include/config.mk \</code><br>        <code>$(obj)board/*/config.tmp $(obj)board/*/*/config.tmp</code><br>    其中“@”的作用是执行该命令时不在shell显示。<br>    “obj”变量就是编译输出的目录，因此<code>unconfig</code>的作用就是清除上次执行<code>make *_config</code>命令生成的配置文件（如<code>include/config.h</code>，<code>include/config.mk</code>等）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">mkconfig：</span><br><span class="line">APPEND=no	# Default: Create <span class="keyword">new</span> config file</span><br><span class="line">BOARD_NAME=<span class="string">""</span>	# Name to print in make output</span><br><span class="line"><span class="comment">/*此处判断传入参数是否符合下列条件</span></span><br><span class="line"><span class="comment">while [ $# -gt 0 ] ; do</span></span><br><span class="line"><span class="comment">	case "$1" in</span></span><br><span class="line"><span class="comment">	--) shift ; break ;;</span></span><br><span class="line"><span class="comment">	-a) shift ; APPEND=yes ;;</span></span><br><span class="line"><span class="comment">	-n) shift ; BOARD_NAME="$&#123;1%%_config&#125;" ; shift ;;</span></span><br><span class="line"><span class="comment">	*)  break ;;</span></span><br><span class="line"><span class="comment">	esac</span></span><br><span class="line"><span class="comment">done</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//BOARD_NAME 为空 此处执行BOARD_NAME="100ask24x0_config"</span></span><br><span class="line">[ <span class="string">"$&#123;BOARD_NAME&#125;"</span> ] || BOARD_NAME=<span class="string">"$1"</span></span><br><span class="line"></span><br><span class="line">[ $# -lt <span class="number">4</span> ] &amp;&amp; <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line">[ $# -gt <span class="number">6</span> ] &amp;&amp; <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">"Configuring for $&#123;BOARD_NAME&#125; board..."</span><span class="comment">//输出</span></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Create link to architecture specific headers</span><br><span class="line">#</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"$SRCTREE"</span> != <span class="string">"$OBJTREE"</span> ] ; then</span><br><span class="line">	mkdir -p $&#123;OBJTREE&#125;/include</span><br><span class="line">	mkdir -p $&#123;OBJTREE&#125;/include2</span><br><span class="line">	cd $&#123;OBJTREE&#125;/include2</span><br><span class="line">	rm -f <span class="keyword">asm</span></span><br><span class="line">	ln -s $&#123;SRCTREE&#125;/include/<span class="keyword">asm</span>-$<span class="number">2</span> <span class="keyword">asm</span></span><br><span class="line">	LNPREFIX=<span class="string">"../../include2/asm/"</span></span><br><span class="line">	cd ../include</span><br><span class="line">	rm -rf <span class="keyword">asm</span>-$<span class="number">2</span></span><br><span class="line">	rm -f <span class="keyword">asm</span></span><br><span class="line">	mkdir <span class="keyword">asm</span>-$<span class="number">2</span></span><br><span class="line">	ln -s <span class="keyword">asm</span>-$<span class="number">2</span> <span class="keyword">asm</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	cd ./include</span><br><span class="line">	rm -f <span class="keyword">asm</span></span><br><span class="line">	ln -s <span class="keyword">asm</span>-$<span class="number">2</span> <span class="keyword">asm</span>  <span class="comment">//导入$2参数  ln -s asm-arm asm </span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">rm -f <span class="keyword">asm</span>-$<span class="number">2</span>/arch<span class="comment">//rm -f asm-arm/arch</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"$6"</span> -o <span class="string">"$6"</span> = <span class="string">"NULL"</span> ] ; then</span><br><span class="line">	ln -s $&#123;LNPREFIX&#125;arch-$<span class="number">3</span> <span class="keyword">asm</span>-$<span class="number">2</span>/arch</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	ln -s $&#123;LNPREFIX&#125;arch-$<span class="number">6</span> <span class="keyword">asm</span>-$<span class="number">2</span>/arch  <span class="comment">//ln -s arch-s3c24x0 asm-arm/arch</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"$2"</span> = <span class="string">"arm"</span> ] ; then</span><br><span class="line">	rm -f <span class="keyword">asm</span>-$<span class="number">2</span>/proc </span><br><span class="line">	ln -s $&#123;LNPREFIX&#125;proc-armv <span class="keyword">asm</span>-$<span class="number">2</span>/proc <span class="comment">//ln -s proc-armv asm-arm/proc </span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Create include file <span class="keyword">for</span> Make</span><br><span class="line">#</span><br><span class="line">echo <span class="string">"ARCH   = $2"</span> &gt;  config.mk <span class="comment">//新建config.mk </span></span><br><span class="line">echo <span class="string">"CPU    = $3"</span> &gt;&gt; config.mk <span class="comment">//追加参数</span></span><br><span class="line">echo <span class="string">"BOARD  = $4"</span> &gt;&gt; config.mk <span class="comment">//追加参数</span></span><br><span class="line"></span><br><span class="line">[ <span class="string">"$5"</span> ] &amp;&amp; [ <span class="string">"$5"</span> != <span class="string">"NULL"</span> ] &amp;&amp; echo <span class="string">"VENDOR = $5"</span> &gt;&gt; config.mk</span><br><span class="line"></span><br><span class="line">[ <span class="string">"$6"</span> ] &amp;&amp; [ <span class="string">"$6"</span> != <span class="string">"NULL"</span> ] &amp;&amp; echo <span class="string">"SOC    = $6"</span> &gt;&gt; config.mk</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Create board specific header file</span><br><span class="line">#</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"$APPEND"</span> = <span class="string">"yes"</span> ]	# Append to existing config file</span><br><span class="line">then</span><br><span class="line">	echo &gt;&gt; config.h</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	&gt; config.h		# Create <span class="keyword">new</span> config file</span><br><span class="line">fi</span><br><span class="line">echo <span class="string">"/* Automatically generated - do not edit */"</span> &gt;&gt;config.h</span><br><span class="line">echo <span class="string">"#include &lt;configs/$1.h&gt;"</span> &gt;&gt;config.h</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>总结：根据配置参数，创建了一些文件 &amp; 一些配置文件的参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.B</span>OARD_NAME=<span class="string">"100ask24x0_config"</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>Create include file <span class="keyword">for</span> Make</span><br><span class="line">ln -s <span class="keyword">asm</span>-arm <span class="keyword">asm</span> </span><br><span class="line">ln -s arch-s3c24x0 <span class="keyword">asm</span>-arm/arch</span><br><span class="line">ln -s proc-armv <span class="keyword">asm</span>-arm/proc </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>Create include file <span class="keyword">for</span>   Make include/config.mk</span><br><span class="line">ARCH   = arm</span><br><span class="line">CPU    = arm920t</span><br><span class="line">BOARD  = <span class="number">100</span>ask24x0</span><br><span class="line">SOC    = s3c24x0</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>Create board specific header file  include &lt;configs/<span class="number">100</span>ask24x0.h&gt;</span><br></pre></td></tr></table></figure>
<h2 id="config-mk"><a href="#config-mk" class="headerlink" title="config.mk"></a>config.mk</h2><p> 顶层目录下的<code>config.mk</code>包含了一些信息，用作于make<br>1.设置obj与src. 由于目标输出到源代码目录下，因此执行完上面的代码后，src和obj都是空。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ifneq ($(OBJTREE),$(SRCTREE))</span><br><span class="line">ifeq ($(CURDIR),$(SRCTREE))</span><br><span class="line">dir :=</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">dir := $(subst $(SRCTREE)/,,$(CURDIR))</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">obj := $(<span class="keyword">if</span> $(dir),$(OBJTREE)/$(dir)/,$(OBJTREE)/)</span><br><span class="line">src := $(<span class="keyword">if</span> $(dir),$(SRCTREE)/$(dir)/,$(SRCTREE)/)</span><br><span class="line"></span><br><span class="line">$(shell mkdir -p $(obj))</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">obj :=</span><br><span class="line">src :=</span><br><span class="line">endif</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>设置编译选项<br>用这3个变量表示交叉编译器的编译选项，在后面Make会检查交叉编译器支持的编译选项，然后将适当的选项添加到这3个变量中。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PLATFORM_RELFLAGS =</span><br><span class="line">PLATFORM_CPPFLAGS =</span><br><span class="line">PLATFORM_LDFLAGS =</span><br><span class="line"></span><br><span class="line">ifeq ($(ARCH),arm)</span><br><span class="line">ifeq ($(CROSS_COMPILE),powerpc-netbsd-)</span><br><span class="line">PLATFORM_CPPFLAGS+= -D__ARM__</span><br><span class="line">endif</span><br><span class="line">ifeq ($(CROSS_COMPILE),powerpc-openbsd-)</span><br><span class="line">PLATFORM_CPPFLAGS+= -D__ARM__</span><br><span class="line">endif</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>3.包含一些板载信息文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ifdef	ARCH</span><br><span class="line">sinclude $(TOPDIR)/$(ARCH)_config.mk	# include architecture dependend rules</span><br><span class="line">endif</span><br><span class="line">ifdef	CPU</span><br><span class="line">sinclude $(TOPDIR)/cpu/$(CPU)/config.mk	# include  CPU	specific rules</span><br><span class="line">endif</span><br><span class="line">ifdef	SOC</span><br><span class="line">sinclude $(TOPDIR)/cpu/$(CPU)/$(SOC)/config.mk	# include  SoC	specific rules</span><br><span class="line">endif</span><br><span class="line">ifdef	VENDOR</span><br><span class="line">BOARDDIR = $(VENDOR)/$(BOARD)</span><br><span class="line">else</span><br><span class="line">BOARDDIR = $(BOARD)</span><br><span class="line">endif</span><br><span class="line">ifdef	BOARD</span><br><span class="line">sinclude $(TOPDIR)/board/$(BOARDDIR)/config.mk	# include board specific rules</span><br><span class="line">endif</span><br></pre></td></tr></table></figure></p>
<p>4.编译器选项<br>    变量CC和CFLAGS在后面的代码定义为延时变量，其中的CC即<code>arm-linux-gcc</code>。函数cc-option用于检查编译器CC是否支持某选项。将2个选项作为参数传递给cc-option函数，该函数调用CC编译器检查参数1是否支持，若支持则函数返回参数1，否则返回参数2 （因此CC编译器必须支持参数1或参数2，若两个都不支持则会编译出错）。可以像下面这样调用cc-option函数，并将支持的选项添加到FLAGS中<code>：FLAGS +=$(call cc-option,option1,option2)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cc-option = $(shell if $(CC) $(CFLAGS) $(1) -S -o /dev/null -xc /dev/null \</span><br><span class="line">		&gt; /dev/null 2&gt;&amp;1; then echo &quot;$(1)&quot;; else echo &quot;$(2)&quot;; fi ;)</span><br></pre></td></tr></table></figure></p>
<p>5.链接脚本配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDSCRIPT := $(TOPDIR)/board/$(BOARDDIR)/u-boot.lds</span><br><span class="line">LDFLAGS += -Bstatic -T $(LDSCRIPT) -Ttext $(TEXT_BASE) $(PLATFORM_LDFLAGS)</span><br></pre></td></tr></table></figure></p>
<p>6.指定链接类型输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ifndef REMOTE_BUILD</span><br><span class="line"></span><br><span class="line">%.s:	%.S</span><br><span class="line">	$(CPP) $(AFLAGS) -o $@ $&lt;</span><br><span class="line">%.o:	%.S</span><br><span class="line">	$(CC) $(AFLAGS) -c -o $@ $&lt;</span><br><span class="line">%.o:	%.c</span><br><span class="line">	$(CC) $(CFLAGS) -c -o $@ $&lt;</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">$(obj)%.s:	%.S</span><br><span class="line">	$(CPP) $(AFLAGS) -o $@ $&lt;</span><br><span class="line">$(obj)%.o:	%.S</span><br><span class="line">	$(CC) $(AFLAGS) -c -o $@ $&lt;</span><br><span class="line">$(obj)%.o:	%.c</span><br><span class="line">	$(CC) $(CFLAGS) -c -o $@ $&lt;</span><br><span class="line">endif</span><br></pre></td></tr></table></figure></p>
<h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><p>1.创建输出目录<br>2.load ARCH, BOARD, and CPU configuration<br>3.load other configuration  include $(TOPDIR)<code>/config.mk</code><br>4.加载板载相关的驱动文件<br>5.Add GCC lib<br>6.链接uboot </p>
<p> make 的时候会包含文件<code>u-boot-1.1.6\board\100ask24x0\config.mk：</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># SMDK2410 has 1 bank of 64 MB DRAM</span><br><span class="line"># 3000&apos;0000 to 3400&apos;0000</span><br><span class="line"># Linux-Kernel is expected to be at 3000&apos;8000, entry 3000&apos;8000</span><br><span class="line"># optionally with a ramdisk at 3080&apos;0000</span><br><span class="line"># we load ourself to 33F8&apos;0000</span><br><span class="line"># download area is 3300&apos;0000</span><br><span class="line"> TEXT_BASE = 0x33F80000</span><br></pre></td></tr></table></figure>
<p> U-Boot编译时将使用TEXT_BASE作为代码段连接的起始地址。<br> 执行make<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(obj)u-boot:		depend version $(SUBDIRS) $(OBJS) $(LIBS) $(LDSCRIPT)</span><br><span class="line">	UNDEF_SYM=`$(OBJDUMP) -x $(LIBS) |sed  -n -e &apos;s/.*\(__u_boot_cmd_.*\)/-u\1/p&apos;|sort|uniq`;\</span><br><span class="line">	cd $(LNDIR) &amp;&amp; $(LD) $(LDFLAGS) $$UNDEF_SYM $(__OBJS) \</span><br><span class="line">		--start-group $(__LIBS) --end-group $(PLATFORM_LIBS) \</span><br><span class="line">		-Map u-boot.map -o u-boot</span><br></pre></td></tr></table></figure></p>
<p>其中LDFLAGS 在<code>config.mk</code>文件中有解析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDSCRIPT := $(TOPDIR)/board/$(BOARDDIR)/u-boot.lds</span><br><span class="line">LDFLAGS += -Bstatic -T $(LDSCRIPT) -Ttext $(TEXT_BASE) $(PLATFORM_LDFLAGS)</span><br></pre></td></tr></table></figure></p>
<p>至此make 分析完毕最后会生成链接地址在  0x33F80000 的bin文件</p>
<h2 id="start-S"><a href="#start-S" class="headerlink" title="start.S"></a>start.S</h2><p>对亍 uboot 的 start.S，主要做的事情就是系统的各个方面的初始化。<br>从大的方面分，可以分成返几个部分：</p>
<blockquote>
<ul>
<li>设置 CPU 模式</li>
<li>关闭看门狗</li>
<li>关闭中断</li>
<li>设置堆栈 sp 指针</li>
<li>清除 bss 段</li>
<li>异常中断处理</li>
</ul>
</blockquote>
<h3 id="语法说明："><a href="#语法说明：" class="headerlink" title="语法说明："></a>语法说明：</h3><h4 id="LDR"><a href="#LDR" class="headerlink" title="LDR"></a>LDR</h4><p>格式：LDR{条件} 目的寄存器，&lt;存储器地址&gt;</p>
<p>LDR指令用亍从存储器中将一个32位的字数据传送到目的寄存器中。该指令通常用亍从存储器中读取32位的字数据到通用寄存器，然后对数据迕行处理。当程序计数器PC作为目的寄存器时，指令从存储器中读取的字数据被当作目的地址，从而可以实现程序流程的跳转。</p>
<p>指令示例：</p>
<blockquote>
<ul>
<li><code>LDR R0，[R1]</code>；将存储器地址为R1的字数据读入寄存器R0。</li>
<li><code>LDR R0，[R1，R2]</code>；将存储器地址为R1+R2的字数据读入寄存器R0。</li>
<li><code>LDR R0，[R1，＃8]</code>；将存储器地址为R1+8的字数据读入寄存器R0。</li>
<li><code>LDR R0，[R1，R2]！</code>；将存储器地址为R1+R2的字数据读入寄存器R0,幵将新地址R1＋R2写入R1。</li>
<li><code>LDR R0，[R1，＃8]！</code>；将存储器地址为R1+8的字数据读入寄存器R0，幵将新地址R1＋8写入R1。</li>
<li><code>LDR R0，[R1]，R2</code>；将存储器地址为R1的字数据读入寄存器R0，幵将新地址R1＋R2写入R1。</li>
<li><code>LDR R0，[R1，R2，LSL＃2]！</code>；将存储器地址为R1＋R2×4的字数据读入寄存器R0，并将新地址R1＋R2×4写入R1。</li>
<li><code>LDRR0，[R1]，R2，LSL＃2</code>；将存储器地址为R1的字数据读入寄存器R0，幵将新地址R1＋R2×4写入R1。</li>
</ul>
</blockquote>
<p> ARM是RISC结构，数据从内存到CPU乊间的移劢叧能通过L/S指令来完成，也就是ldr/str指令。比如想把数据从内存中某处读取到寄存器中，叧能使用ldr比如：<br><code>ldr r0, 0x12345678</code><br>就是把0x12345678返个地址中的值存放到r0中。</p>
<h4 id="MRS"><a href="#MRS" class="headerlink" title="MRS"></a>MRS</h4><p>MRS指令的格式：<br>MRS{条件} 通用寄存器，程序状态寄存器（CPSR戒SPSR）<br>MRS指令用亍将程序状态寄存器的内容传送到通用寄存器中。该指令一般用在以下两种情冴：</p>
<blockquote>
<ul>
<li>当需要改变程序状态寄存器的内容时，可用MRS将程序状态寄存器的内容读入通用寄存器，修改后再写回程序状态寄存器。</li>
<li>当在异常处理戒迕程切换时，需要保存程序状态寄存器的值，可先用该指令读出程序状态寄存器的值，然后保存。</li>
</ul>
</blockquote>
<p>指令示例：<br><code>MRS R0，CPSR</code>；传送CPSR的内容到R0<br><code>MRS R0，SPSR</code>；传送SPSR的内容到R0</p>
<h4 id="BIC"><a href="#BIC" class="headerlink" title="BIC"></a>BIC</h4><p>BIC指令的格式为：<br>BIC{条件}{S} 目的寄存器，操作数1，操作数2<br>BIC指令用亍清除操作数1的某些位，并把结果放置到目的寄存器中。操作数1应是一个寄存器，<br>操作数2可以是一个寄存器，被移位的寄存器，戒一个立即数。操作数2为32位的掩码，如果在<br>掩码中设置了某一位，则清除返一位。未设置的掩码位保持不变</p>
<h4 id="ORR"><a href="#ORR" class="headerlink" title="ORR"></a>ORR</h4><p>ORR指令的格式为：<br>ORR{条件}{S} 目的寄存器，操作数1，操作数2<br>ORR指令用亍在两个操作数上迕行逻辑戒运算，幵把结果放置到目的寄存器中。操作数1应是一个寄存器，操作数2可以是一个寄存器，被移位的寄存器，戒一个立即数。该指令常用亍设置操作数1的某些位。</p>
<p>指令示例：<br><code>ORR R0，R0，＃3</code>； 该指令设置R0的0、 1位，其余位保持丌变。</p>
<h4 id="MSR"><a href="#MSR" class="headerlink" title="MSR"></a>MSR</h4><p>MSR指令的格式为：<br>MSR{条件} 程序状态寄存器（CPSR戒SPSR）_&lt;域&gt;，操作数<br>MSR指令用亍将操作数的内容传送到程序状态寄存器的特定域中。其中，操作数可以为通用寄<br>存器戒立即数。 &lt;域&gt;用亍设置程序状态寄存器中需要操作的位，32位的程序状态寄存器可分为<br>4个域：<br>位[31：24]为条件标志位域，用f表示；<br>位[23：16]为状态位域，用s表示；<br>位[15：8]为扩展位域，用x表示；<br>位[7：0]为控制位域，用c表示；<br>该指令通常用亍恢复戒改变程序状态寄存器的内容，在使用时，一般要在MSR指令中指明将要<br>操作的域。</p>
<p>指令示例：<br><code>MSR CPSR，R0</code>；传送R0的内容到CPSR<br><code>MSR SPSR，R0</code> ；传送R0的内容到SPSR<br><code>MSR CPSR_c，R0</code> ；传送R0的内容到SPSR，但仅仅修改CPSR中的控制位域</p>
<h4 id="ldr伪指令，"><a href="#ldr伪指令，" class="headerlink" title="ldr伪指令，"></a>ldr伪指令，</h4><p>虽然ldr伪指令和ARM的ldr指令很像，但是作用并太一样。 ldr<br>伪指令可以在立即数前加上=，以表示把一个地址写到某寄存器中，比如：<br><code>ldr r0, =0x12345678</code>返样，就把 0x12345678 返个地址写到 r0 中了。所以，ldr 伪指令和 mov 是比较相似的。”只不过 mov 指令后面的立即数是有限制的，返个立即数，能够必须由一个 8 位的二迚制数，即属亍 0x00-0xFF 内的某个值，经过偶数次右移后得到，这样才是合法数据，而 ldr 伪指令没有<br>返个限制。那为何 ldr 伪指令的操作数没有限制呢，那是因为其是伪指令，写出来的伪指令，最终会被编译器解释成为真正的，合法的指令的，一般都是对应的 mov 指令。返样的话，写汇编程序的时候，使用 MOV 指令是比较麻烦的，因为有些简单的数据比较容易看出来，有些数据即丌容易看出来是否是合法数据。所以，对此，ldr 伪指令的出现，就是为了解决返个问题的，你叧管放心用 ldr 伪指令，不用关心操作数，而写出的 ldr 伪指令，编译器会帮你翻译成对应的真正的汇编指令的。</p>
<h4 id="MOV指令"><a href="#MOV指令" class="headerlink" title="MOV指令"></a>MOV指令</h4><p>MOV指令的格式为：<br>MOV{条件}{S} 目的寄存器，源操作数<br>MOV指令可完成从另一个寄存器、被移位的寄存器戒将一个立即数加载到目的寄存器。其中S选项决定指令的操作是否影响CPSR中条件标志位的值，当没有S时指令丌更新CPSR中条件标志<br>位的值。</p>
<p>指令示例：<br><code>MOV R1，R0</code> ；将寄存器R0的值传送到寄存器R1<br><code>MOV PC，R14</code> ；将寄存器R14的值传送到PC，常用亍子程序迒回<br><code>MOV R1，R0，LSL＃3</code> ；将寄存器R0的值左移3位后传送到R1”</p>
<p>对亍MOV指令多说一句，那就是，一般可以用类似亍：<br>MOV R0，R0<br>的指令来实现NOP操作</p>
<h4 id="STR指令"><a href="#STR指令" class="headerlink" title="STR指令"></a>STR指令</h4><p>STR指令的格式为：<br>STR{条件} 源寄存器，&lt;存储器地址&gt;<br>STR指令用亍从源寄存器中将一个32位的字数据传送到存储器中。该指令在程序设计中比较常<br>用，丏寻址方式灵活多样，使用方式可参考指令LDR。<br>指令示例：<br><code>STR R0，[R1]，＃8</code>；将R0中的字数据写入以R1为地址的存储器中，幵<br>将新地址R1＋8写入R1。<br><code>STR R0，[R1，＃8]</code>；将R0中的字数据写入以R1＋8为地址的存储器中。 </p>
<h4 id="bl指令："><a href="#bl指令：" class="headerlink" title="bl指令："></a>bl指令：</h4><p>b指令，是单纯的跳转指令，即CPU直接跳转到某地址继续执行。<br>而BL是Branch with Link，带分支的跳转，而Link指的是Link Register，链接寄存器R14，即lr，<br>所以，bl的含义是，除了包含b指令的单纯的跳转功能，在跳转乊前，迓把r15寄存器=PC=cpu<br>地址，赋值给r14=lr，然后跳转到对应位置，等要做的事情执行完毕乊后，再用<br>mov pc, lr<br>使得cpu再跳转回来，所以整个逻辑就是调用子程序的意思</p>
<p>BL指令的格式为：<br>BL{条件} 目标地址<br>BL 是另一个跳转指令，但跳转乊前，会在寄存器R14中保存PC的当前内容，因此，可以通过将<br>R14 的内容重新加载到PC中，来迒回到跳转指令乊后的那个指令处执行。该指令是实现子程序<br>调用的一个基本但常用的手段。以下指令：<br>BL Label ；当程序无条件跳转到标号Label处执行时，同时将当前的PC值保存到R14中</p>
<h4 id="sub指令："><a href="#sub指令：" class="headerlink" title="sub指令："></a>sub指令：</h4><p>SUB : 减法<br>(Subtraction)<br>SUB{条件}{S} <dest>, <op 1="">, <op 2="">dest = op_1 - op_2<br>SUB 用操作数 one 减去操作数 two，把结果放置到目的寄存器中。操作数 1 是一个寄存器，<br>操作数 2 可以是一个寄存器，被移位的寄存器，戒一个立即值:<br>SUB R0, R1, R2 ; R0 = R1 - R2<br>SUB R0, R1, #256 ; R0 = R1 - 256<br>SUB R0, R2, R3,LSL#1 ; R0 = R2 - (R3 &lt;&lt; 1)<br>减法可以在有符号和无符号数上迕行。 </op></op></dest></p>
<h4 id="ADR伪指令"><a href="#ADR伪指令" class="headerlink" title="ADR伪指令"></a>ADR伪指令</h4><p>— 小范围的地址读取<br>ADR伪指令将基亍PC相对偏移的地址值戒基亍寄存器相对偏移的地址值读取到寄存器中。<br>在汇编编译器编译源程序时，ADR伪指令被编译器替换成一条合适的指令。通常，编译器用一<br>条ADD指令戒SUB指令来实现该ADR伪指令的功能，若丌能用一条指令实现，则产生错诨，编<br>译失败。<br>ADR伪指令格式 ：ADR{cond} register, expr<br>地址表达式expr的取值范围：<br>当地址值是字节对齐时，其取指范围为: +255 ～ 255B；<br>当地址值是字对齐时，其取指范围为: -1020 ～ 1020B</p>
<h4 id="MCR指令"><a href="#MCR指令" class="headerlink" title="MCR指令"></a>MCR指令</h4><p>MCR指令将ARM处理器的寄存器中的数据传送到协处理器寄存器中。如果协处理器不能成功地<br>执行该操作，将产生未定义的指令异常中断。<br>指令语法格式<br>MCR{<cond>} <p>，&lt; opcode_1&gt;，<rd>,<crn>,<crm>{,&lt;opcode_2&gt;}<br>MCR{<cond>} p15，0，<rd>,<crn>,<crm>{,&lt;opcode_2&gt;}<br>其中，<cond>为指令执行的条件码。当<cond>忽略时指令为无条件执行。<br>&lt; opcode_1&gt;为协处理器将执行的操作的操作码。对亍CP15协处理器来说，&lt; opcode_1&gt;永<br>远为0b000，当&lt; opcode_1&gt;不为0b000时，该指令操作结果不可预知。</cond></cond></crm></crn></rd></cond></crm></crn></rd></p>
<p><rd>作为源寄存器的ARM寄存器，其值将被传送到协处理器寄存器中。</rd></p>
<p><crn>作为目标寄存器的协处理器寄存器，其编号可能是C0，C1，…，C15。</crn></p>
<p><crm>和&lt;opcode_2&gt;两者组合决定对协处理器寄存器迚行所需要的操作，如果没有指定，<br>则将为<crm>为C0，opcode_2为0</crm></crm></p>
<p>ps：<br>ARM 微处理器可支持多达 16 个协处理器，用亍各种协处理操作，在程序执行的过程中，每个<br>协处理器叧执行针对自身的协处理指令，忽略 ARM 处理器和其他协处理器的指令。 ARM 的<br>协处理器指令主要用亍 ARM 处理器初始化 ARM 协处理器的数据处理操作，以及在ARM 处<br>理器的寄存器和协处理器的寄存器乊间传送数据，和在 ARM 协处理器的寄存器和存储器乊间<br>传送数据。 ARM 协处理器指令包括以下 5 条：<br>— CDP 协处理器数操作指令<br>— LDC 协处理器数据加载指令<br>— STC 协处理器数据存储指令<br>— MCR ARM 处理器寄存器到协处理器寄存器的数据传送指令<br>— MRC 协处理器寄存器到ARM 处理器寄存器的数据传送指令<br>。。。<br>CP15系统控制协处理器<br>CP15 —系统控制协处理器 （the system control coprocessor）他通过协处理器指令MCR和<br>MRC提供具体的寄存器来配置和控制caches、 MMU、保护系统、配置时钟模式（在bootloader<br>时钟初始化用到）<br>CP15的寄存器叧能被MRC和MCR（Move to Coprocessor from ARM Register ）指令访问</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Jump vector table as in table 3.1 in [1]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.globl _start   <span class="comment">/*声明一个符号可被其它文件引用，相当于声明了一个全局变量，.globl与.global相同*/</span></span><br><span class="line">_start:	b       reset <span class="comment">/* 复位，b是不带返回的跳转(bl是带返回的跳转)，意思是无条件直接跳转到reset标号出执行程序*/</span></span><br><span class="line">	ldr	pc, _undefined_instruction  	<span class="comment">/* 未定义指令向量 l---dr相当于mov操作*/</span></span><br><span class="line">	ldr	pc, _software_interrupt 	<span class="comment">/*  软件中断向量 */</span></span><br><span class="line">	ldr	pc, _prefetch_abort  <span class="comment">/*  预取指令异常向量 */</span></span><br><span class="line">	ldr	pc, _data_abort     <span class="comment">/*  数据操作异常向量 */</span></span><br><span class="line">	ldr	pc, _not_used       <span class="comment">/*  未使用   */</span></span><br><span class="line">	ldr	pc, _irq   			<span class="comment">/*  irq中断向量  */</span>	</span><br><span class="line">	ldr	pc, _fiq 	 <span class="comment">/*  fiq中断向量  */</span></span><br><span class="line"><span class="comment">/*  中断向量表入口地址 */</span></span><br><span class="line">_undefined_instruction:	.word undefined_instruction</span><br><span class="line">_software_interrupt:	.word software_interrupt</span><br><span class="line">_prefetch_abort:	.word prefetch_abort</span><br><span class="line">_data_abort:		.word data_abort</span><br><span class="line">_not_used:		.word not_used</span><br><span class="line">_irq:		.word irq</span><br><span class="line">_fiq:		.word fiq</span><br><span class="line"></span><br><span class="line">	.balignl <span class="number">16</span>,<span class="number">0xdeadbeef</span></span><br></pre></td></tr></table></figure>
<p>上面那些ldr的作用，以第一个_undefined_instruction为例，就是将地址为<br><code>_undefined_instruction</code>中的一个word的值，赋值给pc</p>
<p><code>.globl</code><br>就是相当亍C诧言中的Extern，声明此变量，幵丏告诉链接器此变量是全尿<br>的，外部可以访问</p>
<p><code>.word</code><br>.word expr {,expr}… 分配一段字内存单元，幵用expr初始化字内存单元(32bit)</p>
<p>ldr pc, 标号1<br>。。。<br>标号1：.word 标号2<br>标号2：<br>。。。（具体要执行的代码）<br>的意思就是，将地址为标号1中内容载入到pc，而地址为标号1中的内容，正好装的是标号2。<br>用C诧言表达其实很简单：<br>PC = *（标号1） = 标号2</p>
<p>对PC赋值，即是实现代码跳转，所以整个返段汇编代码的意思就是：<br>跳转到标号2的位置，执行对应的代码<br><code>.balignl</code><br>字节对齐</p>
<p>总体功能：<br>当一个异常产生时，CPU根据异常号在异常向量表中找到对应的异常向量，然后执行异常向量处的跳转指令，CPU就跳转到对应的异常处理程序执行。其中复位异常向量的指令“b reset”决定了U-Boot启动后将自动跳转到标号“reset”处执行。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Startup Code (reset vector)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * do important init only if we don't start from memory!</span></span><br><span class="line"><span class="comment"> * relocate armboot to ram</span></span><br><span class="line"><span class="comment"> * setup stack</span></span><br><span class="line"><span class="comment"> * jump to second stage</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">_TEXT_BASE:</span><br><span class="line">	.word	TEXT_BASE  <span class="comment">//TEXT_BASE = 0x33F80000 .\u-boot-1.1.6_jz2440\u-boot-1.1.6\board\100ask24x0\config.mk</span></span><br><span class="line"></span><br><span class="line">.globl _armboot_start</span><br><span class="line">_armboot_start:</span><br><span class="line">	.word _start</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These are defined in the board-specific linker script.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">.globl _bss_start</span><br><span class="line">_bss_start:</span><br><span class="line">	.word __bss_start</span><br><span class="line"></span><br><span class="line">.globl _bss_end</span><br><span class="line">_bss_end:</span><br><span class="line">	.word _end</span><br><span class="line"></span><br><span class="line">.globl FREE_RAM_END</span><br><span class="line">FREE_RAM_END:</span><br><span class="line">	.word	<span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line">.globl FREE_RAM_SIZE</span><br><span class="line">FREE_RAM_SIZE:</span><br><span class="line">	.word	<span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line">.globl PreLoadedONRAM</span><br><span class="line">PreLoadedONRAM:</span><br><span class="line">	.word	<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_USE_IRQ</span></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl IRQ_STACK_START</span><br><span class="line">IRQ_STACK_START:</span><br><span class="line">	.word	<span class="number">0x0badc0de</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* IRQ stack memory (calculated at run-time) */</span></span><br><span class="line">.globl FIQ_STACK_START</span><br><span class="line">FIQ_STACK_START:</span><br><span class="line">	.word <span class="number">0x0badc0de</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>以上定义一些与外部链接的名称</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * the actual reset code</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * set the cpu to SVC32 mode</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mrs	r0,cpsr</span><br><span class="line">	bic	r0,r0,#<span class="number">0x1f</span></span><br><span class="line">	orr	r0,r0,#<span class="number">0xd3</span></span><br><span class="line">	msr	cpsr,r0</span><br></pre></td></tr></table></figure>
<p>CPSR 是当前的程序状态寄存器(Current Program Status Register)<br>SPSR 是保存的程序状态寄存器(Saved Program Status Register)</p>
<p>以上代码将CPU的工作模式位设置为管理模式，即设置相应的CPSR程序状态字，并将中断禁止位和快中断禁止位置一，从而屏蔽了IRQ和FIQ中断。</p>
<p>操作系统先注册一个总的中断，然后去查是由哪个中断源产生的中断，再去查用户注册的中断表，查出来后就去执行用户定义的用户中断处理函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* turn off the watchdog */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_S3C2400)</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> pWTCON		0x15300000</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> INTMSK		0x14400008	<span class="comment">/* Interupt-Controller base addresses */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CLKDIVN	0x14800014	<span class="comment">/* clock divisor register */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_S3C2410)</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> pWTCON		0x53000000</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> INTMOD     0X4A000004</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> INTMSK		0x4A000008	<span class="comment">/* Interupt-Controller base addresses */</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> INTSUBMSK	0x4A00001C</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CLKDIVN	0x4C000014	<span class="comment">/* clock divisor register */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_S3C2400) || defined(CONFIG_S3C2410)</span></span><br><span class="line">	ldr     r0, =pWTCON</span><br><span class="line">	mov     r1, #<span class="number">0x0</span></span><br><span class="line">	str     r1, [r0]</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mask all IRQs by setting all bits in the INTMR - default</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mov	r1, #<span class="number">0xffffffff</span></span><br><span class="line">	ldr	r0, =INTMSK</span><br><span class="line">	str	r1, [r0]</span><br><span class="line"># <span class="keyword">if</span> defined(CONFIG_S3C2410)</span><br><span class="line">	ldr	r1, =<span class="number">0x3ff</span></span><br><span class="line">	ldr	r0, =INTSUBMSK</span><br><span class="line">	str	r1, [r0]</span><br><span class="line"># endif</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> <span class="number">0</span></span><br><span class="line">	<span class="comment">/* FCLK:HCLK:PCLK = 1:2:4 */</span></span><br><span class="line">	<span class="comment">/* default FCLK is 120 MHz ! */</span></span><br><span class="line">	ldr	r0, =CLKDIVN</span><br><span class="line">	mov	r1, #<span class="number">3</span></span><br><span class="line">	str	r1, [r0]</span><br><span class="line">#endif</span><br><span class="line">#endif	<span class="comment">/* CONFIG_S3C2400 || CONFIG_S3C2410 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * we do sys-critical inits only at reboot,</span></span><br><span class="line"><span class="comment">	 * not when booting from ram!</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br><span class="line">	adr	r0, _start		<span class="comment">/* r0 &lt;- current position of code   */</span></span><br><span class="line">	ldr	r1, _TEXT_BASE		<span class="comment">/* test if we run from flash or RAM */</span></span><br><span class="line">	cmp     r0, r1                  <span class="comment">/* don't reloc during debug         */</span></span><br><span class="line">	blne	cpu_init_crit</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set up the stack						    */</span></span><br><span class="line">stack_setup:</span><br><span class="line">	ldr	r0, _TEXT_BASE		<span class="comment">/* upper 128 KiB: relocated uboot   */</span></span><br><span class="line">	sub	r0, r0, #CFG_MALLOC_LEN	<span class="comment">/* malloc area                      */</span></span><br><span class="line">	sub	r0, r0, #CFG_GBL_DATA_SIZE <span class="comment">/* bdinfo                        */</span></span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_USE_IRQ</span><br><span class="line">	sub	r0, r0, #(CONFIG_STACKSIZE_IRQ+CONFIG_STACKSIZE_FIQ)</span><br><span class="line">#endif</span><br><span class="line">	sub	sp, r0, #<span class="number">12</span>		<span class="comment">/* leave 3 words for abort-stack    */</span></span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br><span class="line">    bl clock_init</span><br><span class="line">#endif    </span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_SKIP_RELOCATE_UBOOT</span><br><span class="line">relocate:				<span class="comment">/* relocate U-Boot to RAM	    */</span></span><br><span class="line">	adr	r0, _start		<span class="comment">/* r0 &lt;- current position of code   */</span></span><br><span class="line">	ldr	r1, _TEXT_BASE		<span class="comment">/* test if we run from flash or RAM */</span></span><br><span class="line">	cmp     r0, r1                  <span class="comment">/* don't reloc during debug         */</span></span><br><span class="line">	beq     clear_bss</span><br><span class="line">	</span><br><span class="line">	ldr	r2, _armboot_start</span><br><span class="line">	ldr	r3, _bss_start</span><br><span class="line">	sub	r2, r3, r2		<span class="comment">/* r2 &lt;- size of armboot            */</span></span><br><span class="line">#<span class="keyword">if</span> <span class="number">1</span></span><br><span class="line">	bl  CopyCode2Ram	<span class="comment">/* r0: source, r1: dest, r2: size */</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">	add	r2, r0, r2		<span class="comment">/* r2 &lt;- source end address         */</span></span><br><span class="line"></span><br><span class="line">copy_loop:</span><br><span class="line">	ldmia	r0!, &#123;r3-r10&#125;		<span class="comment">/* copy from source address [r0]    */</span></span><br><span class="line">	stmia	r1!, &#123;r3-r10&#125;		<span class="comment">/* copy to   target address [r1]    */</span></span><br><span class="line">	cmp	r0, r2			<span class="comment">/* until source end addreee [r2]    */</span></span><br><span class="line">	ble	copy_loop</span><br><span class="line">#endif</span><br><span class="line">#endif	<span class="comment">/* CONFIG_SKIP_RELOCATE_UBOOT */</span></span><br><span class="line"></span><br><span class="line">clear_bss:</span><br><span class="line">	ldr	r0, _bss_start		<span class="comment">/* find start of bss segment        */</span></span><br><span class="line">	ldr	r1, _bss_end		<span class="comment">/* stop here                        */</span></span><br><span class="line">	mov 	r2, #<span class="number">0x00000000</span>		<span class="comment">/* clear                            */</span></span><br><span class="line"></span><br><span class="line">clbss_l:str	r2, [r0]		<span class="comment">/* clear loop...                    */</span></span><br><span class="line">	add	r0, r0, #<span class="number">4</span></span><br><span class="line">	cmp	r0, r1</span><br><span class="line">	ble	clbss_l</span><br><span class="line"></span><br><span class="line">SetLoadFlag:</span><br><span class="line">	<span class="comment">/* Set a global flag, PreLoadedONRAM */</span></span><br><span class="line">	adr	r0, _start		<span class="comment">/* r0 &lt;- current position of code   */</span></span><br><span class="line">	ldr	r1, _TEXT_BASE		<span class="comment">/* test if we run from flash or RAM */</span></span><br><span class="line">	cmp     r0, r1                  <span class="comment">/* don't reloc during debug         */</span></span><br><span class="line">	ldr r2, =PreLoadedONRAM</span><br><span class="line">	mov r3, #<span class="number">1</span></span><br><span class="line">	streq r3, [r2]</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> <span class="number">0</span></span><br><span class="line">	<span class="comment">/* try doing this stuff after the relocation */</span></span><br><span class="line">	ldr     r0, =pWTCON</span><br><span class="line">	mov     r1, #<span class="number">0x0</span></span><br><span class="line">	str     r1, [r0]</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * mask all IRQs by setting all bits in the INTMR - default</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mov	r1, #<span class="number">0xffffffff</span></span><br><span class="line">	ldr	r0, =INTMR</span><br><span class="line">	str	r1, [r0]</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* FCLK:HCLK:PCLK = 1:2:4 */</span></span><br><span class="line">	<span class="comment">/* default FCLK is 120 MHz ! */</span></span><br><span class="line">	ldr	r0, =CLKDIVN</span><br><span class="line">	mov	r1, #<span class="number">3</span></span><br><span class="line">	str	r1, [r0]</span><br><span class="line">	<span class="comment">/* END stuff after relocation */</span></span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	ldr	pc, _start_armboot</span><br><span class="line"></span><br><span class="line">_start_armboot:	.word start_armboot</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * CPU_init_critical registers</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * setup important registers</span></span><br><span class="line"><span class="comment"> * setup memory timing</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SKIP_LOWLEVEL_INIT</span></span><br><span class="line">cpu_init_crit:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * flush v4 I/D caches</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mov	r0, #<span class="number">0</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, r0, c7, c7, <span class="number">0</span>	<span class="comment">/* flush v3/v4 cache */</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, r0, c8, c7, <span class="number">0</span>	<span class="comment">/* flush v4 TLB */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * disable MMU stuff and caches</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mrc	p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line">	bic	r0, r0, #<span class="number">0x00002300</span>	@ clear bits <span class="number">13</span>, <span class="number">9</span>:<span class="number">8</span> (--V- --RS)</span><br><span class="line">	bic	r0, r0, #<span class="number">0x00000087</span>	@ clear bits <span class="number">7</span>, <span class="number">2</span>:<span class="number">0</span> (B--- -CAM)</span><br><span class="line">	orr	r0, r0, #<span class="number">0x00000002</span>	@ <span class="built_in">set</span> bit <span class="number">2</span> (A) Align</span><br><span class="line">	orr	r0, r0, #<span class="number">0x00001000</span>	@ <span class="built_in">set</span> bit <span class="number">12</span> (I) I-Cache</span><br><span class="line">	mcr	p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * before relocating, we have to setup RAM timing</span></span><br><span class="line"><span class="comment">	 * because memory timing is board-dependend, you will</span></span><br><span class="line"><span class="comment">	 * find a lowlevel_init.S in your board directory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mov	ip, lr</span><br><span class="line">	bl	lowlevel_init</span><br><span class="line">	mov	lr, ip</span><br><span class="line">	mov	pc, lr</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_SKIP_LOWLEVEL_INIT */</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Interrupt handling</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *************************************************************************</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">@</span><br><span class="line">@ IRQ <span class="built_in">stack</span> frame.</span><br><span class="line">@</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_FRAME_SIZE	72</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_OLD_R0	68</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_PSR		64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_PC		60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_LR		56</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_SP		52</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_IP		48</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_FP		44</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R10		40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R9		36</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R8		32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R7		28</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R6		24</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R5		20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R4		16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R3		12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R2		8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R1		4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> S_R0		0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODE_SVC 0x13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> I_BIT	 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * use bad_save_user_regs for abort/prefetch/undef/swi ...</span></span><br><span class="line"><span class="comment"> * use irq_save_user_regs / irq_restore_user_regs for IRQ/FIQ handling</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">	.macro	bad_save_user_regs</span><br><span class="line">	sub	sp, sp, #S_FRAME_SIZE</span><br><span class="line">	stmia	sp, &#123;r0 - r12&#125;			@ Calling r0-r12</span><br><span class="line">	ldr	r2, _armboot_start</span><br><span class="line">	sub	r2, r2, #(CONFIG_STACKSIZE+CFG_MALLOC_LEN)</span><br><span class="line">	sub	r2, r2, #(CFG_GBL_DATA_SIZE+<span class="number">8</span>)  @ <span class="built_in">set</span> base <span class="number">2</span> words into <span class="built_in">abort</span> <span class="built_in">stack</span></span><br><span class="line">	ldmia	r2, &#123;r2 - r3&#125;			@ get pc, cpsr</span><br><span class="line">	add	r0, sp, #S_FRAME_SIZE		@ restore sp_SVC</span><br><span class="line"></span><br><span class="line">	add	r5, sp, #S_SP</span><br><span class="line">	mov	r1, lr</span><br><span class="line">	stmia	r5, &#123;r0 - r3&#125;			@ save sp_SVC, lr_SVC, pc, cpsr</span><br><span class="line">	mov	r0, sp</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro	irq_save_user_regs</span><br><span class="line">	sub	sp, sp, #S_FRAME_SIZE</span><br><span class="line">	stmia	sp, &#123;r0 - r12&#125;			@ Calling r0-r12</span><br><span class="line">	add     r8, sp, #S_PC</span><br><span class="line">	stmdb   r8, &#123;sp, lr&#125;^                   @ Calling SP, LR</span><br><span class="line">	str     lr, [r8, #<span class="number">0</span>]                    @ Save calling PC</span><br><span class="line">	mrs     r6, spsr</span><br><span class="line">	str     r6, [r8, #<span class="number">4</span>]                    @ Save CPSR</span><br><span class="line">	str     r0, [r8, #<span class="number">8</span>]                    @ Save OLD_R0</span><br><span class="line">	mov	r0, sp</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro	irq_restore_user_regs</span><br><span class="line">	ldmia	sp, &#123;r0 - lr&#125;^			@ Calling r0 - lr</span><br><span class="line">	mov	r0, r0</span><br><span class="line">	ldr	lr, [sp, #S_PC]			@ Get PC</span><br><span class="line">	add	sp, sp, #S_FRAME_SIZE</span><br><span class="line">	subs	pc, lr, #<span class="number">4</span>			@ <span class="keyword">return</span> &amp; move spsr_svc into cpsr</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro get_bad_stack</span><br><span class="line">	ldr	r13, _armboot_start		@ setup our mode <span class="built_in">stack</span></span><br><span class="line">	sub	r13, r13, #(CONFIG_STACKSIZE+CFG_MALLOC_LEN)</span><br><span class="line">	sub	r13, r13, #(CFG_GBL_DATA_SIZE+<span class="number">8</span>) @ reserved a couple spots in <span class="built_in">abort</span> <span class="built_in">stack</span></span><br><span class="line"></span><br><span class="line">	str	lr, [r13]			@ save caller lr / spsr</span><br><span class="line">	mrs	lr, spsr</span><br><span class="line">	str     lr, [r13, #<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">	mov	r13, #MODE_SVC			@ prepare SVC-Mode</span><br><span class="line">	@ msr	spsr_c, r13</span><br><span class="line">	msr	spsr, r13</span><br><span class="line">	mov	lr, pc</span><br><span class="line">	movs	pc, lr</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro get_irq_stack			@ setup IRQ <span class="built_in">stack</span></span><br><span class="line">	ldr	sp, IRQ_STACK_START</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line">	.macro get_fiq_stack			@ setup FIQ <span class="built_in">stack</span></span><br><span class="line">	ldr	sp, FIQ_STACK_START</span><br><span class="line">	.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * exception handlers</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	.align  <span class="number">5</span></span><br><span class="line">undefined_instruction:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_undefined_instruction</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">software_interrupt:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_software_interrupt</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">prefetch_abort:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_prefetch_abort</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">data_abort:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_data_abort</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">not_used:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_not_used</span><br><span class="line"></span><br><span class="line">@ thisway.diy, <span class="number">2006.06</span><span class="number">.24</span></span><br><span class="line">.globl Launch</span><br><span class="line">    .align	<span class="number">4</span></span><br><span class="line">Launch:    </span><br><span class="line">    mov r7, r0</span><br><span class="line">    @ diable interrupt</span><br><span class="line">	@ disable watch dog timer</span><br><span class="line">	mov	r1, #<span class="number">0x53000000</span></span><br><span class="line">	mov	r2, #<span class="number">0x0</span></span><br><span class="line">	str	r2, [r1]</span><br><span class="line"></span><br><span class="line">    ldr r1,=INTMSK</span><br><span class="line">    ldr r2,=<span class="number">0xffffffff</span>  @ all interrupt disable</span><br><span class="line">    str r2,[r1]</span><br><span class="line"></span><br><span class="line">    ldr r1,=INTSUBMSK</span><br><span class="line">    ldr r2,=<span class="number">0x7ff</span>       @ all sub interrupt disable</span><br><span class="line">    str r2,[r1]</span><br><span class="line"></span><br><span class="line">    ldr     r1, = INTMOD</span><br><span class="line">    mov r2, #<span class="number">0x0</span>        @ <span class="built_in">set</span> all interrupt as IRQ (<span class="keyword">not</span> FIQ)</span><br><span class="line">    str     r2, [r1]</span><br><span class="line"></span><br><span class="line">    @ </span><br><span class="line">	mov	ip, #<span class="number">0</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, ip, c13, c0, <span class="number">0</span>      @	<span class="comment">/* zero PID */</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, ip, c7, c7, <span class="number">0</span>       @	<span class="comment">/* invalidate I,D caches */</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, ip, c7, c10, <span class="number">4</span>      @	<span class="comment">/* drain write buffer */</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, ip, c8, c7, <span class="number">0</span>       @	<span class="comment">/* invalidate I,D TLBs */</span></span><br><span class="line">	mrc	p15, <span class="number">0</span>, ip, c1, c0, <span class="number">0</span>       @	<span class="comment">/* get control register */</span></span><br><span class="line">	bic	ip, ip, #<span class="number">0x0001</span>             @	<span class="comment">/* disable MMU */</span></span><br><span class="line">	mcr	p15, <span class="number">0</span>, ip, c1, c0, <span class="number">0</span>       @	<span class="comment">/* write control register */</span></span><br><span class="line"></span><br><span class="line">    @ MMU_EnableICache</span><br><span class="line">    @mrc p15,<span class="number">0</span>,r1,c1,c0,<span class="number">0</span></span><br><span class="line">    @orr r1,r1,#(<span class="number">1</span>&lt;&lt;<span class="number">12</span>)</span><br><span class="line">    @mcr p15,<span class="number">0</span>,r1,c1,c0,<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    @ clear SDRAM: the end of <span class="built_in">free</span> mem(has wince on it now) to the end of SDRAM</span><br><span class="line">    ldr     r3, FREE_RAM_END</span><br><span class="line">    ldr     r4, =PHYS_SDRAM_1+PHYS_SDRAM_1_SIZE    @ must clear all the memory unused to zero</span><br><span class="line">    mov     r5, #<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    ldr     r1, _armboot_start</span><br><span class="line">    ldr     r2, =On_Steppingstone</span><br><span class="line">    sub     r2, r2, r1</span><br><span class="line">    mov     pc, r2</span><br><span class="line">On_Steppingstone:</span><br><span class="line"><span class="number">2</span>:  stmia   r3!, &#123;r5&#125;</span><br><span class="line">    cmp     r3, r4</span><br><span class="line">    bne     <span class="number">2b</span></span><br><span class="line"></span><br><span class="line">    @ <span class="built_in">set</span> sp = <span class="number">0</span> on sys mode</span><br><span class="line">    mov sp, #<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    @ add by thisway.diy <span class="number">2006.06</span><span class="number">.26</span>, <span class="keyword">switch</span> to SVC mode</span><br><span class="line">	msr	cpsr_c,	#<span class="number">0xdf</span>	@ <span class="built_in">set</span> the I-bit = <span class="number">1</span>, diable the IRQ interrupt</span><br><span class="line">	msr	cpsr_c,	#<span class="number">0xd3</span>	@ <span class="built_in">set</span> the I-bit = <span class="number">1</span>, diable the IRQ interrupt</span><br><span class="line">    ldr sp, =<span class="number">0x31ff5800</span>	</span><br><span class="line">    </span><br><span class="line">    nop</span><br><span class="line">	nop</span><br><span class="line">    nop</span><br><span class="line">	nop</span><br><span class="line"></span><br><span class="line">	mov     pc, r7  @ Jump to PhysicalAddress</span><br><span class="line">	nop</span><br><span class="line">    mov pc, lr</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_USE_IRQ</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">irq:</span><br><span class="line"><span class="comment">/* add by www.100ask.net to use IRQ for USB and DMA */</span></span><br><span class="line">	sub	lr, lr, #<span class="number">4</span>			        @ the <span class="keyword">return</span> address</span><br><span class="line">	ldr	sp, IRQ_STACK_START	        @ the <span class="built_in">stack</span> <span class="keyword">for</span> irq</span><br><span class="line">	stmdb	sp!, 	&#123; r0-r12,lr &#125;	@ save registers</span><br><span class="line">	</span><br><span class="line">	ldr	lr,	=int_return		        @ <span class="built_in">set</span> the <span class="keyword">return</span> addr</span><br><span class="line">	ldr	pc, =IRQ_Handle		        @ call the isr</span><br><span class="line">int_return:</span><br><span class="line">	ldmia	sp!, 	&#123; r0-r12,pc &#125;^	@ <span class="keyword">return</span> from interrupt</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">fiq:</span><br><span class="line">	get_fiq_stack</span><br><span class="line">	<span class="comment">/* someone ought to write a more effiction fiq_save_user_regs */</span></span><br><span class="line">	irq_save_user_regs</span><br><span class="line">	bl 	do_fiq</span><br><span class="line">	irq_restore_user_regs</span><br><span class="line"></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">irq:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_irq</span><br><span class="line"></span><br><span class="line">	.align	<span class="number">5</span></span><br><span class="line">fiq:</span><br><span class="line">	get_bad_stack</span><br><span class="line">	bad_save_user_regs</span><br><span class="line">	bl 	do_fiq</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h3 id="start-S-各个部分的总结"><a href="#start-S-各个部分的总结" class="headerlink" title="start.S 各个部分的总结"></a>start.S 各个部分的总结</h3><p>其实关亍 start.S 返个汇编文件，主要做的事情就是系统的各个方面的初始化。<br>如前所述，可以分成返几个部分：<br>（1）设置 CPU 模式<br>（2）关闭看门狗<br>（3）关闭中断<br>（4）设置堆栈 sp 指针<br>（5）清除 bss 段<br>（6）异常中断处理<br>关亍每个部分，上面具体的代码实现，也都一行行的解释过了，此处丌再赘述。<br>此处，叧是简单总结一下，其实现的方式，戒者其他需要注意的地方。<br>（1）设置 CPU 模式<br>总的来说，就是将 CPU 设置为 SVC 模式。<br>至亍为何设置 CPU 是 SVC 模式，请参见后面章节的详细解释。<br>（2）关闭看门狗<br>就是去设置对应的寄存器，将看门狗关闭。<br>至亍为何关闭看门狗，请参见后面章节的详细解释。<br>（3）关闭中断<br>关闭中断，也是去设置对应的寄存器，即可。<br>（4）设置堆栈 sp 指针<br>所谓的设置堆栈 sp 指针，返样的句子，乊前听到 N 次了，但是说实话，一直丌太理解，到<br>底更深一局的含义是什么。<br>后来，看了更多的代码，才算有一点点了解。所谓的设置堆栈 sp 指针，就是设置堆栈，而<br>所谓的设置堆栈，要做的事情，看起来很简单，就叧是一个很简单的劢作：让 sp 等亍某个<br>地址值，即可。<br>但是背后的逻辑是：<br>首先你自己要搞懂当前系统是如何使用堆栈的，堆栈是向上生长的迓是向下生长的。<br>然后知道系统如何使用堆栈乊后，给 sp 赋值乊前，你要保证对应的地址空间，是与门分配<br>好了，与门给堆栈用的，保证堆栈的大小相对合适，而丌要太小以至亍后期凼数调用太多，导致堆栈溢出，戒者堆栈太大，浪费存储空间，等等。<br>所有返些背后的逻辑，都是要绊过一定的编程绊验，才更加容易理解其中的含义的。<br>此处，也叧是简单说说，更多相关的内容，迓是要靠每个人自己多实践，慢慢的更加深入的<br>理解。<br>（5）清除 bss 段<br>此处很简单，就是将对应 bss 段，都设置为,0，即清零。<br>其对应的地址空间，就是那些未初始化的全尿变量乊类的地址。<br>（6）异常中断处理<br>异常中断处理，就是实现对应的常见的那些处理中断的部分内容。<br>说白了就是实现一个个中断凼数。 uboot在初始化的时候，主要目的叧是为了初始化系统，及引<br>导系统，所以，此处的中断处理部分的代码，往往相对比较简单，丌是很复杂</p>
<h3 id="uboot内存分布"><a href="#uboot内存分布" class="headerlink" title="uboot内存分布"></a>uboot内存分布</h3><p>uboot内存分布 ：<br>                    <img src="./images/1522514778594.jpg" alt="enter description here"></p>
<h1 id="2-Linux"><a href="#2-Linux" class="headerlink" title="2.Linux"></a>2.Linux</h1><h1 id="3-Application"><a href="#3-Application" class="headerlink" title="3.Application"></a>3.Application</h1></cond></p>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/30/ARM-Linux-note/" data-id="cjfe2sdz30001jgjgeoq8x8kd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/30/hello-world/" class="article-date">
  <time datetime="2018-03-30T12:55:40.945Z" itemprop="datePublished">2018-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/30/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/30/hello-world/" data-id="cjfe2sdyy0000jgjg14t5cba6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/30/ARM-Linux-note/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/03/30/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>